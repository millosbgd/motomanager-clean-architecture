<div class="container">
  <header>
    <!-- Filters Section -->
    <div *ngIf="showFilters" class="filters-section">
      <div class="filter-group">
        <label for="filterDateFrom">Datum od:</label>
        <input type="date" id="filterDateFrom" [(ngModel)]="filterDateFrom" (ngModelChange)="applyFilters()" />
      </div>
      <div class="filter-group">
        <label for="filterDateTo">Datum do:</label>
        <input type="date" id="filterDateTo" [(ngModel)]="filterDateTo" (ngModelChange)="applyFilters()" />
      </div>
      <div class="filter-group">
        <label for="filterDobavljac">Dobavljaƒç:</label>
        <select id="filterDobavljac" [(ngModel)]="filterDobavljacId" (ngModelChange)="applyFilters()">
          <option [ngValue]="null">-- Svi dobavljaƒçi --</option>
          <option *ngFor="let client of clients" [ngValue]="client.id">{{ client.naziv }}</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="filterVozilo">Vozilo:</label>
        <select id="filterVozilo" [(ngModel)]="filterVoziloId" (ngModelChange)="applyFilters()">
          <option [ngValue]="null">-- Sva vozila --</option>
          <option *ngFor="let vehicle of vehicles" [ngValue]="vehicle.id">{{ vehicle.model }} ({{ vehicle.plate }})</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="filterSektor">Sektor:</label>
        <select id="filterSektor" [(ngModel)]="filterSektorId" (ngModelChange)="applyFilters()">
          <option [ngValue]="null">-- Svi sektori --</option>
          <option *ngFor="let sektor of sektori" [ngValue]="sektor.id">{{ sektor.naziv }}</option>
        </select>
      </div>
      <div class="filter-actions">
        <button class="btn btn-secondary" (click)="clearFilters()">Obri≈°i filtere</button>
      </div>
    </div>
    
    <div class="list-header">
      <button class="btn-icon btn-icon-filter" (click)="toggleFilters()" title="{{ showFilters ? 'Sakrij filtere' : 'Prika≈æi filtere' }}">
        {{ showFilters ? '‚ñ≤' : '‚ñº' }}
      </button>
      <div class="list-header-right">
        <button class="btn-icon btn-icon-add" (click)="showAddInvoiceForm()" title="Dodaj novi raƒçun dobavljaƒça">
          +
        </button>
        <button class="btn-icon btn-icon-export" (click)="openExportDialog()" title="Export u Excel">
          üìÑ
        </button>
      </div>
    </div>
  </header>

  <div *ngIf="loading" class="loading">Uƒçitavanje...</div>
  <div *ngIf="error" class="error">{{ error }}</div>

  <section class="invoice-list">
    <table *ngIf="filteredInvoices && filteredInvoices.length > 0">
      <thead>
        <tr>
          <th>Broj raƒçuna</th>
          <th>Datum</th>
          <th>Dobavljaƒç</th>
          <th>Vozilo</th>
          <th>Sektor</th>
          <th>Iznos neto</th>
          <th>PDV</th>
          <th>Bruto iznos</th>
          <th>Akcije</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let invoice of filteredInvoices; trackBy: trackByInvoiceId">
          <td>{{ invoice.brojRacuna }}</td>
          <td>{{ formatDate(invoice.datum) }}</td>
          <td>{{ invoice.dobavljacNaziv }}</td>
          <td>{{ invoice.voziloModel ? invoice.voziloModel + ' (' + invoice.voziloPlate + ')' : '-' }}</td>
          <td>{{ invoice.sektorNaziv || '-' }}</td>
          <td>{{ invoice.iznosNeto | number:'1.2-2' }}</td>
          <td>{{ invoice.iznosPDV | number:'1.2-2' }}</td>
          <td>{{ invoice.iznosBruto | number:'1.2-2' }}</td>
          <td class="actions">
            <button class="btn-icon btn-icon-edit" (click)="editInvoice(invoice)" title="Izmeni">‚úé</button>
            <button class="btn-icon btn-icon-delete" (click)="deleteInvoice(invoice.id)" title="Obri≈°i">üóë</button>
          </td>
        </tr>
      </tbody>
      <tfoot>
        <tr class="totals-row">
          <td colspan="5">UKUPNO:</td>
          <td>{{ getTotalNeto() | number:'1.2-2' }}</td>
          <td>{{ getTotalPDV() | number:'1.2-2' }}</td>
          <td>{{ getTotalBruto() | number:'1.2-2' }}</td>
          <td></td>
        </tr>
      </tfoot>
    </table>
    <p *ngIf="filteredInvoices && filteredInvoices.length === 0 && !loading" class="no-data">Nema raƒçuna dobavljaƒça koji odgovaraju filterima.</p>
    
    <!-- Pagination Controls -->
    <div *ngIf="totalPages > 1" class="pagination">
      <button class="pagination-btn" (click)="previousPage()" [disabled]="currentPage === 1">
        &#8249;
      </button>
      
      <button *ngFor="let page of pageNumbers" 
              class="pagination-btn"
              [class.active]="page === currentPage"
              (click)="goToPage(page)">
        {{ page }}
      </button>
      
      <button class="pagination-btn" (click)="nextPage()" [disabled]="currentPage === totalPages">
        &#8250;
      </button>
      
      <span class="pagination-info">
        Strana {{ currentPage }} od {{ totalPages }} (ukupno {{ totalCount }} stavki)
      </span>
    </div>
  </section>

  <!-- Modal za dodavanje ulaznog raƒçuna -->
  <div *ngIf="showAddForm" class="modal-overlay" (mousedown)="cancelAdd()">
    <div class="modal-content" (mousedown)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Dodaj novi raƒçun dobavljaƒça</h2>
        <button class="close-btn" (click)="cancelAdd()">&times;</button>
      </div>
      <form (ngSubmit)="addInvoice()">
        <div class="form-group">
          <label for="brojRacuna">Broj raƒçuna:</label>
          <input type="text" id="brojRacuna" name="brojRacuna" [(ngModel)]="newInvoice.brojRacuna" required />
        </div>
        <div class="form-group">
          <label for="datum">Datum:</label>
          <input type="date" id="datum" name="datum" 
                 [ngModel]="newInvoice.datum | date:'yyyy-MM-dd'" 
                 (ngModelChange)="newInvoice.datum = $event" required />
        </div>
        <div class="form-group">
          <label for="dobavljacId">Dobavljaƒç:</label>
          <select id="dobavljacId" name="dobavljacId" [(ngModel)]="newInvoice.dobavljacId" required>
            <option value="0">-- Izaberite dobavljaƒça --</option>
            <option *ngFor="let client of clients" [value]="client.id">{{ client.naziv }}</option>
          </select>
        </div>
        <div class="form-group">
          <label for="voziloId">Vozilo (opciono):</label>
          <select id="voziloId" name="voziloId" [(ngModel)]="newInvoice.voziloId">
            <option [ngValue]="null">-- Bez vozila --</option>
            <option *ngFor="let vehicle of vehicles" [value]="vehicle.id">
              {{ vehicle.model }} ({{ vehicle.plate }})
            </option>
          </select>
        </div>
        <div class="form-group">
          <label for="sektorId">Sektor:</label>
          <select id="sektorId" name="sektorId" [(ngModel)]="newInvoice.sektorId">
            <option [ngValue]="null">-- Bez sektora --</option>
            <option *ngFor="let sektor of sektori" [value]="sektor.id">
              {{ sektor.naziv }}
            </option>
          </select>
        </div>
        <div class="form-group">
          <label for="iznosNeto">Iznos neto (RSD):</label>
          <input type="number" id="iznosNeto" name="iznosNeto" 
                 [(ngModel)]="newInvoice.iznosNeto" 
                 (ngModelChange)="calculateAmounts()" 
                 step="0.01" required />
        </div>
        <div class="form-group">
          <label for="iznosPDV">PDV (RSD):</label>
          <input type="number" id="iznosPDV" name="iznosPDV" 
                 [(ngModel)]="newInvoice.iznosPDV" 
                 (ngModelChange)="calculateAmounts()" 
                 step="0.01" required />
        </div>
        <div class="form-group">
          <label for="iznosBruto">Bruto iznos (RSD):</label>
          <input type="number" id="iznosBruto" name="iznosBruto" 
                 [(ngModel)]="newInvoice.iznosBruto" 
                 step="0.01" readonly />
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Dodaj</button>
          <button type="button" class="btn btn-cancel" (click)="cancelAdd()">Odustani</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal za a≈æuriranje ulaznog raƒçuna -->
  <div *ngIf="editingInvoice" class="modal-overlay" (mousedown)="cancelEdit()">
    <div class="modal-content" (mousedown)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Izmeni raƒçun dobavljaƒça</h2>
        <button class="close-btn" (click)="cancelEdit()">&times;</button>
      </div>
      <form (ngSubmit)="updateInvoice()">
        <div class="form-group">
          <label for="edit-brojRacuna">Broj raƒçuna:</label>
          <input type="text" id="edit-brojRacuna" name="brojRacuna" 
                 [(ngModel)]="updatedInvoice.brojRacuna" required />
        </div>
        <div class="form-group">
          <label for="edit-datum">Datum:</label>
          <input type="date" id="edit-datum" name="datum" 
                 [ngModel]="updatedInvoice.datum | date:'yyyy-MM-dd'" 
                 (ngModelChange)="updatedInvoice.datum = $event" required />
        </div>
        <div class="form-group">
          <label for="edit-dobavljacId">Dobavljaƒç:</label>
          <select id="edit-dobavljacId" name="dobavljacId" 
                  [(ngModel)]="updatedInvoice.dobavljacId" required>
            <option value="0">-- Izaberite dobavljaƒça --</option>
            <option *ngFor="let client of clients" [value]="client.id">{{ client.naziv }}</option>
          </select>
        </div>
        <div class="form-group">
          <label for="edit-voziloId">Vozilo (opciono):</label>
          <select id="edit-voziloId" name="voziloId" [(ngModel)]="updatedInvoice.voziloId">
            <option [ngValue]="null">-- Bez vozila --</option>
            <option *ngFor="let vehicle of vehicles" [value]="vehicle.id">
              {{ vehicle.model }} ({{ vehicle.plate }})
            </option>
          </select>
        </div>
        <div class="form-group">
          <label for="edit-sektorId">Sektor:</label>
          <select id="edit-sektorId" name="sektorId" [(ngModel)]="updatedInvoice.sektorId">
            <option [ngValue]="null">-- Bez sektora --</option>
            <option *ngFor="let sektor of sektori" [value]="sektor.id">
              {{ sektor.naziv }}
            </option>
          </select>
        </div>
        <div class="form-group">
          <label for="edit-iznosNeto">Iznos neto (RSD):</label>
          <input type="number" id="edit-iznosNeto" name="iznosNeto" 
                 [(ngModel)]="updatedInvoice.iznosNeto" 
                 (ngModelChange)="calculateAmounts()" 
                 step="0.01" required />
        </div>
        <div class="form-group">
          <label for="edit-iznosPDV">PDV (RSD):</label>
          <input type="number" id="edit-iznosPDV" name="iznosPDV" 
                 [(ngModel)]="updatedInvoice.iznosPDV" 
                 (ngModelChange)="calculateAmounts()" 
                 step="0.01" required />
        </div>
        <div class="form-group">
          <label for="edit-iznosBruto">Bruto iznos (RSD):</label>
          <input type="number" id="edit-iznosBruto" name="iznosBruto" 
                 [(ngModel)]="updatedInvoice.iznosBruto" 
                 step="0.01" readonly />
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Saƒçuvaj</button>
          <button type="button" class="btn btn-cancel" (click)="cancelEdit()">Odustani</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal za export u Excel -->
  <app-export-dialog 
    *ngIf="showExportDialog"
    [clients]="clients"
    [vehicles]="vehicles"
    (export)="onExport($event)"
    (cancel)="closeExportDialog()">
  </app-export-dialog>
</div>
